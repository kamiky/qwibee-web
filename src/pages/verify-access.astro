---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import { useTranslations } from "@/i18n/translations";

const lang = "en";
const t = useTranslations(lang);
---

<Layout 
  title={t.seo.verifyAccess.title} 
  description={t.seo.verifyAccess.description}
  lang={lang}
>
  <Header lang={lang} />
  <LanguageSwitcher lang={lang} />

  <main class="pt-24 pb-12 min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="max-w-2xl mx-auto px-6">
      <!-- Loading State -->
      <div id="loading-container" class="text-center">
        <div class="mb-8">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-brand-blue-500"
          >
          </div>
        </div>
        <h1 class="text-3xl font-bold mb-4 text-gray-900">
          {t.verifyAccess.loading.title}
        </h1>
        <p class="text-xl text-gray-600">
          {t.verifyAccess.loading.subtitle}
        </p>
      </div>

      <!-- Success State (hidden by default) -->
      <div id="success-container" class="hidden">
        <div class="text-center mb-12">
          <div class="text-6xl mb-6">{t.verifyAccess.success.icon}</div>
          <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-gray-900">
            {t.verifyAccess.success.title}
          </h1>
          <p class="text-xl text-gray-700 mb-2">
            {t.verifyAccess.success.subtitle}
          </p>
          <p class="text-lg text-gray-600">
            {t.verifyAccess.success.info}
          </p>
        </div>

        <div
          class="bg-white rounded-2xl p-8 border border-gray-200 shadow-lg mb-8"
        >
          <div
            class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6"
          >
            <p class="text-sm text-green-700 mb-2">
              <strong>{t.verifyAccess.success.purchaseDate}</strong>
              <span id="purchase-date"></span>
            </p>
            <p class="text-sm text-green-700">
              <strong>{t.verifyAccess.success.email}</strong>
              <span id="recovered-email"></span>
            </p>
          </div>

          <a
            href="/"
            class="block w-full bg-brand-blue-500 hover:bg-brand-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center transition-colors shadow-lg hover:shadow-xl"
          >
            {t.verifyAccess.success.viewButton}
          </a>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
          <h3 class="text-lg font-bold text-blue-700 mb-3">
            {t.verifyAccess.success.nextSteps.title}
          </h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.success.nextSteps.tip1}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.success.nextSteps.tip2}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.success.nextSteps.tip3}</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Error State (hidden by default) -->
      <div id="error-container" class="hidden">
        <div class="text-center mb-12">
          <div class="text-6xl mb-6">{t.verifyAccess.error.icon}</div>
          <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-gray-900">
            {t.verifyAccess.error.title}
          </h1>
          <p class="text-xl text-gray-600">
            {t.verifyAccess.error.subtitle}
          </p>
        </div>

        <div
          class="bg-white rounded-2xl p-8 border border-gray-200 shadow-lg mb-8"
        >
          <div
            class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6"
          >
            <p class="text-red-700 mb-2">
              <strong>{t.verifyAccess.error.errorLabel}</strong>
            </p>
            <p class="text-red-600" id="error-message"></p>
          </div>

          <div class="space-y-3">
            <a
              href="/recover-access"
              class="block w-full bg-brand-blue-500 hover:bg-brand-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center transition-colors shadow-lg hover:shadow-xl"
            >
              {t.verifyAccess.error.requestNewLink}
            </a>
            <a
              href="/contact"
              class="block w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg text-center transition-colors"
            >
              {t.verifyAccess.error.contactSupport}
            </a>
          </div>
        </div>

        <!-- Common Issues -->
        <div
          class="bg-white rounded-xl p-6 border border-gray-200 shadow-md"
        >
          <h3 class="text-lg font-bold mb-3 text-gray-900">
            {t.verifyAccess.error.commonIssues.title}
          </h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.error.commonIssues.issue1}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.error.commonIssues.issue2}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.verifyAccess.error.commonIssues.issue3}</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Back Link -->
      <div class="text-center mt-8">
        <a
          href="/"
          class="text-brand-blue-500 hover:text-brand-blue-600 transition-colors"
        >
          {t.verifyAccess.backLink}
        </a>
      </div>
    </div>
  </main>

  <Footer lang={lang} />

  <script>
    const loadingContainer = document.getElementById("loading-container");
    const successContainer = document.getElementById("success-container");
    const errorContainer = document.getElementById("error-container");
    const errorMessage = document.getElementById("error-message");

    async function verifyMagicLink() {
      try {
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        if (!token) {
          showError(
            "Missing verification token. Please check your email for the correct link."
          );
          return;
        }

        // Verify the magic link
        const response = await fetch("/api/stripe/verify-magic-link", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ token }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Failed to verify magic link");
        }

        // Store the access token
        localStorage.setItem("animated_wallpapers_access", data.token);
        console.log("✓ Access token stored successfully");

        // Show success
        if (loadingContainer) loadingContainer.classList.add("hidden");
        if (successContainer) successContainer.classList.remove("hidden");

        // Fill in details
        const purchaseDateEl = document.getElementById("purchase-date");
        const recoveredEmailEl = document.getElementById("recovered-email");

        if (purchaseDateEl && data.purchaseDate) {
          purchaseDateEl.textContent = new Date(
            data.purchaseDate
          ).toLocaleDateString();
        }
        if (recoveredEmailEl) {
          recoveredEmailEl.textContent = data.email;
        }
      } catch (error) {
        console.error("Verification error:", error);
        showError(error instanceof Error ? error.message : "Failed to verify magic link");
      }
    }

    function showError(message: string) {
      if (loadingContainer) loadingContainer.classList.add("hidden");
      if (errorContainer) errorContainer.classList.remove("hidden");
      if (errorMessage) errorMessage.textContent = message;
    }

    // Auto-verify on page load
    verifyMagicLink();
  </script>
</Layout>
