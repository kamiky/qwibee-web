---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import { useTranslations, type Language } from "@/i18n/translations";

// Detect language from URL path
const pathname = Astro.url.pathname;
const lang: Language = pathname.startsWith('/fr/') || pathname === '/fr' || pathname.startsWith('/fr/login') ? 'fr' : 'en';
const t = useTranslations(lang);
---

<Layout
  title="Login Successful - WatchMeFans"
  description="You've been successfully logged in"
  lang={lang}
>
  <Header lang={lang} />
  <LanguageSwitcher lang={lang} />

  <main
    class="pt-24 pb-12 min-h-screen bg-gradient-to-br from-gray-50 to-gray-100"
  >
    <div class="max-w-2xl mx-auto px-6">
      <!-- Loading State -->
      <div id="loading-container" class="text-center">
        <div class="mb-8">
          <div
            class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-brand-blue-500"
          >
          </div>
        </div>
        <h1 class="text-3xl font-bold mb-4 text-gray-900">
          {t.auth.loginSuccess.verifying}
        </h1>
        <p class="text-xl text-gray-600">
          {t.auth.loginSuccess.wait}
        </p>
      </div>

      <!-- Success State -->
      <div id="success-container" class="text-center hidden">
        <div class="mb-8">
          <div class="text-6xl mb-6">✅</div>
          <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-gray-900">
            {t.auth.loginSuccess.successTitle}
          </h1>
          <p class="text-xl text-gray-700 mb-2">
            {t.auth.loginSuccess.welcomeBack}
          </p>
          <p class="text-lg text-gray-600" id="redirect-message">
            {t.auth.loginSuccess.redirecting}
          </p>
        </div>

        <div
          class="bg-white rounded-2xl p-8 border border-gray-200 shadow-lg mb-8"
        >
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-green-700">
              <strong>Email:</strong>
              <span id="user-email" class="ml-2"></span>
            </p>
          </div>

          <div class="space-y-3">
            <a
              id="continue-link"
              href="/"
              class="block w-full bg-brand-blue-500 hover:bg-brand-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center transition-colors shadow-lg hover:shadow-xl"
            >
              {t.auth.loginSuccess.continue}
            </a>
          </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
          <h3 class="text-lg font-bold text-blue-700 mb-3">{t.auth.loginSuccess.whatsNext}</h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.auth.loginSuccess.saved}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.auth.loginSuccess.accessContent}</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-brand-blue-500 mt-1">•</span>
              <span>{t.auth.loginSuccess.lostAccess}</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Back Link -->
      <div class="text-center mt-8">
        <a
          href="/"
          class="text-brand-blue-500 hover:text-brand-blue-600 transition-colors"
        >
          {t.auth.backLink}
        </a>
      </div>
    </div>
  </main>

  <Footer lang={lang} />

  <script define:vars={{ translations: t }}>
    import { storeAuth } from "@/lib/auth";

    const loadingContainer = document.getElementById("loading-container");
    const successContainer = document.getElementById("success-container");
    const userEmailEl = document.getElementById("user-email");
    const redirectMessage = document.getElementById("redirect-message");
    const continueLink = document.getElementById("continue-link");

    async function verifyMagicLink() {
      try {
        // Get token and redirect from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        const redirectTo = urlParams.get("redirect");
        const openStripe = urlParams.get("openStripe");

        if (!token) {
          // No token - user navigated directly here, check if already logged in
          const existingAuth = localStorage.getItem("wmf_access_token");
          if (!existingAuth) {
            window.location.href = "/login";
            return;
          }
          
          // Already logged in, show success
          showSuccess(null, redirectTo, openStripe === "true");
          return;
        }

        // Verify the magic link
        const response = await fetch("/api/auth/verify-magic-link", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ token }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Failed to verify magic link");
        }

        const accessToken = data.data.accessToken;
        const refreshToken = data.data.refreshToken;
        const user = data.data.user;

        // Store authentication data
        storeAuth({
          accessToken,
          refreshToken,
          user,
        });
        console.log("✓ Authentication stored successfully");

        // Trigger header update by dispatching storage event
        window.dispatchEvent(new Event('storage'));

        // Show success
        showSuccess(user.email, redirectTo, openStripe === "true");

      } catch (error) {
        console.error("Verification error:", error);
        // Redirect to login with error
        window.location.href = "/login?error=" + encodeURIComponent(
          error instanceof Error ? error.message : "Failed to verify magic link"
        );
      }
    }

    function showSuccess(email, redirectTo, shouldOpenStripe) {
      // Hide loading, show success
      if (loadingContainer) loadingContainer.classList.add("hidden");
      if (successContainer) successContainer.classList.remove("hidden");

      // Get email from params or storage
      const finalEmail = email || JSON.parse(localStorage.getItem("wmf_user") || "{}").email;
      if (userEmailEl && finalEmail) {
        userEmailEl.textContent = finalEmail;
      }

      // Handle redirect
      if (redirectTo) {
        // Update UI
        if (redirectMessage) {
          redirectMessage.textContent = translations.auth.loginSuccess.redirectingToCreator;
        }
        if (continueLink) {
          continueLink.setAttribute("href", redirectTo);
          continueLink.textContent = translations.auth.loginSuccess.continueToCreator;
        }

        // Store flag if we need to open Stripe
        if (shouldOpenStripe) {
          sessionStorage.setItem("wmf_open_stripe_after_login", "true");
        }

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = redirectTo;
        }, 2000);
      } else {
        // No redirect URL, just show generic message
        if (redirectMessage) {
          redirectMessage.textContent = translations.auth.loginSuccess.browse;
        }
        if (continueLink) {
          continueLink.textContent = translations.auth.loginSuccess.goToHome;
        }
      }
    }

    // Auto-verify on page load
    verifyMagicLink();
  </script>
</Layout>
