---
import LayoutApp from "@/layouts/LayoutApp.astro";
import { useTranslations, type Language } from "@/i18n/translations";
import { PRICING_GROUPS, type PriceGroup } from "@/data/pricing-groups";

const lang = "en";
const t = useTranslations(lang);

// Get or assign price group from cookie
const PRICE_GROUP_COOKIE = "qwb_price_group";
function getPriceGroupFromCookie(): PriceGroup {
  const priceGroupId = Astro.cookies.get(PRICE_GROUP_COOKIE)?.value;

  if (!priceGroupId) {
    // First time visitor - assign random price group
    const randomIndex = Math.floor(Math.random() * PRICING_GROUPS.length);
    const priceGroup = PRICING_GROUPS[randomIndex];
    Astro.cookies.set(PRICE_GROUP_COOKIE, priceGroup.id, {
      path: "/",
      maxAge: 60 * 60 * 24 * 365, // 1 year
      sameSite: "lax",
      secure: import.meta.env.PROD,
    });
    return priceGroup;
  }

  // Return existing price group
  const priceGroup = PRICING_GROUPS.find((g) => g.id === priceGroupId);
  return priceGroup || PRICING_GROUPS[0];
}

const selectedPriceGroup = getPriceGroupFromCookie();

// Check if user has app membership or lifetime purchase
let hasAppAccess = false;
let userEmail: string | null = null;
let isLoggedIn = false;
const accessToken = Astro.cookies.get('qwb_access_token')?.value;

if (accessToken) {
  try {
    const backendUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:5002';
    const response = await fetch(`${backendUrl}/auth/verify-token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ token: accessToken }),
    });

    if (response.ok) {
      const data = await response.json();
      
      if (data.data.valid) {
        isLoggedIn = true;
        userEmail = data.data.user?.email || null;
        
        // Check for app membership (profileId === null, type === "apps")
        const appMembership = data.data.memberships?.find(
          (m: any) => m.type === 'apps' && (m.status === 'active' || m.status === 'trialing')
        );
        
        // Check for app lifetime purchase (type === "apps")
        const appLifetimePurchase = data.data.purchasedContent?.find(
          (pc: any) => pc.type === 'apps'
        );
        
        hasAppAccess = !!(appMembership || appLifetimePurchase);
      }
    }
  } catch (error) {
    console.error('Error verifying app access:', error);
  }
}
---

<LayoutApp
  title={t.seo.home.title}
  description={t.seo.home.description}
  lang={lang}
>
  <div class="home-wrapper">
    <!-- Video Background -->
    <div class="video-container">
      <video autoplay muted loop playsinline class="video-bg">
        <source src="/animations/glowing-circles.mp4" type="video/mp4" />
      </video>
      <div class="video-overlay"></div>
    </div>

    <!-- Top right corner - User info -->
    {isLoggedIn && userEmail && (
      <div class="user-info-corner">
        <a href="/account" class="user-email-link">
          {userEmail}
        </a>
      </div>
    )}

    <!-- Mysterious Content -->
    <div class="content">
      <!-- Glitch Logo/Title -->
      <div class="glitch-wrapper">
        <h1 class="glitch" data-text="q">q</h1>
      </div>

      <!-- Cryptic Messages -->
      <div class="messages">
        <p class="message message-1">Get access to our best</p>
        <p class="message message-2">apps and tutorials</p>
        <!-- <p class="message message-3">Are you ready to see?</p> -->
      </div>

      <!-- CTA Buttons Container -->
      <div class="cta-container">
        {hasAppAccess ? (
          <!-- Single CTA to explore apps -->
          <div class="explore-apps">
            <a href="/apps" class="enter-btn explore-btn">
              <span class="btn-text">Explore apps & tutos</span>
              <span class="btn-glow"></span>
            </a>
          </div>
        ) : (
          <!-- Two buttons with prices (shown when no access) -->
          <div class="dual-buttons">
            <div class="price-button-wrapper">
              <button class="enter-btn membership-btn">
                <span class="btn-text">Monthly Access</span>
                <span class="btn-price"
                  >${selectedPriceGroup.membership.monthly}/mo</span
                >
                <span class="btn-glow"></span>
              </button>
            </div>
            <div class="price-button-wrapper">
              <button class="enter-btn lifetime-btn">
                <span class="btn-text">Lifetime Access</span>
                <span class="btn-price">${selectedPriceGroup.lifetime.price}</span>
                <span class="btn-glow"></span>
              </button>
            </div>
          </div>
        )}
        
        {/* Show login link if user is not logged in */}
        {!isLoggedIn && !hasAppAccess && (
          <div class="login-link-container">
            <a href="/login" class="login-link">
              Already have access? Login
            </a>
          </div>
        )}
      </div>

      <!-- Floating Orbs -->
      <div class="orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
      </div>

      <!-- Scanlines Effect -->
      <div class="scanlines"></div>

      <!-- Bottom Cryptic Text -->
      <div class="bottom-text">
        <p class="cryptic">◆ Those who seek shall find ◆</p>
        <p class="cryptic-small">But what will they discover?</p>
      </div>
    </div>

    <style>
      .home-wrapper * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Video Background */
      .home-wrapper .video-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .home-wrapper .video-bg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: brightness(0.6) contrast(1.2);
      }

      .home-wrapper .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle at center,
          transparent 0%,
          rgba(0, 0, 0, 0.7) 100%
        );
        pointer-events: none;
      }

      /* Main Content */
      .home-wrapper .content {
        position: relative;
        z-index: 10;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      /* Glitch Effect Title */
      .home-wrapper .glitch-wrapper {
        margin-bottom: 4rem;
      }

      .glitch {
        font-size: clamp(4rem, 15vw, 12rem);
        font-weight: 700;
        text-transform: uppercase;
        position: relative;
        text-shadow:
          0 0 40px rgba(255, 0, 255, 0.8),
          0 0 80px rgba(0, 255, 255, 0.6);
        color: #fff;
        letter-spacing: 0.5rem;
        animation: glitch-anim 3s infinite;
      }

      @keyframes glitch-anim {
        0%,
        90%,
        100% {
          transform: translate(0);
        }
        91% {
          transform: translate(-2px, -2px);
          text-shadow:
            0 0 40px rgba(255, 0, 255, 0.8),
            2px 2px 0 #ff00ff,
            -2px -2px 0 #00ffff;
        }
        93% {
          transform: translate(2px, 2px);
          text-shadow:
            0 0 40px rgba(0, 255, 255, 0.8),
            -2px -2px 0 #ff00ff,
            2px 2px 0 #00ffff;
        }
        95% {
          transform: translate(0);
        }
      }

      .home-wrapper .glitch::before,
      .home-wrapper .glitch::after {
        content: attr(data-text);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.8;
      }

      .home-wrapper .glitch::before {
        animation: glitch-anim-1 2.5s infinite;
        clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
        transform: translate(-2px, -1px);
        text-shadow: 2px 0 #ff00ff;
      }

      .home-wrapper .glitch::after {
        animation: glitch-anim-2 2.5s infinite;
        clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
        transform: translate(2px, 1px);
        text-shadow: -2px 0 #00ffff;
      }

      @keyframes glitch-anim-1 {
        0%,
        100% {
          clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
          transform: translate(0);
        }
        20% {
          clip-path: polygon(0 15%, 100% 15%, 100% 65%, 0 65%);
          transform: translate(-5px, 2px);
        }
        40% {
          clip-path: polygon(0 35%, 100% 35%, 100% 85%, 0 85%);
          transform: translate(3px, -1px);
        }
        60% {
          clip-path: polygon(0 10%, 100% 10%, 100% 40%, 0 40%);
          transform: translate(-2px, 3px);
        }
        80% {
          clip-path: polygon(0 60%, 100% 60%, 100% 95%, 0 95%);
          transform: translate(4px, -2px);
        }
      }

      @keyframes glitch-anim-2 {
        0%,
        100% {
          clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
          transform: translate(0);
        }
        20% {
          clip-path: polygon(0 70%, 100% 70%, 100% 90%, 0 90%);
          transform: translate(4px, -3px);
        }
        40% {
          clip-path: polygon(0 20%, 100% 20%, 100% 50%, 0 50%);
          transform: translate(-3px, 2px);
        }
        60% {
          clip-path: polygon(0 45%, 100% 45%, 100% 75%, 0 75%);
          transform: translate(2px, -4px);
        }
        80% {
          clip-path: polygon(0 5%, 100% 5%, 100% 35%, 0 35%);
          transform: translate(-4px, 3px);
        }
      }

      /* Messages */
      .home-wrapper .messages {
        margin-bottom: 3rem;
        text-align: center;
      }

      .message {
        font-size: clamp(1rem, 3vw, 1.5rem);
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 0.3rem;
        margin: 0.8rem 0;
        opacity: 0;
        animation: fade-in 2s ease-in-out forwards;
        text-shadow:
          0 0 20px rgba(255, 0, 255, 0.5),
          0 0 40px rgba(0, 255, 255, 0.3);
      }

      .home-wrapper .message-1 {
        animation-delay: 0.5s;
      }

      .home-wrapper .message-2 {
        animation-delay: 1s;
      }

      .home-wrapper .message-3 {
        animation-delay: 1.5s;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* User Info Corner */
      .home-wrapper .user-info-corner {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 200;
        opacity: 0;
        animation: fade-in 1s ease-in-out 0.5s forwards;
      }

      .home-wrapper .user-email-link {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
        border: 1px solid rgba(255, 0, 255, 0.4);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        box-shadow: 0 0 20px rgba(255, 0, 255, 0.2);
        display: inline-block;
      }

      .home-wrapper .user-email-link:hover {
        border-color: rgba(0, 255, 255, 0.6);
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
        transform: translateY(-2px);
        background: rgba(0, 0, 0, 0.7);
      }

      /* CTA Container */
      .home-wrapper .cta-container {
        margin-top: 2rem;
        opacity: 0;
        animation: fade-in 2s ease-in-out 2s forwards;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      /* Explore Apps Button */
      .home-wrapper .explore-apps {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .home-wrapper .explore-btn {
        text-decoration: none;
        display: inline-block;
        border-color: rgba(0, 255, 255, 0.8);
        box-shadow:
          0 0 40px rgba(0, 255, 255, 0.5),
          inset 0 0 40px rgba(0, 255, 255, 0.2);
      }

      .home-wrapper .explore-btn:hover {
        border-color: rgba(255, 0, 255, 0.9);
        box-shadow:
          0 0 60px rgba(255, 0, 255, 0.7),
          inset 0 0 40px rgba(255, 0, 255, 0.3);
      }

      /* Dual Buttons Layout */
      .home-wrapper .dual-buttons {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .home-wrapper .price-button-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Enter Button */
      .home-wrapper .enter-btn {
        position: relative;
        padding: 1.2rem 3rem;
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        font-weight: 700;
        letter-spacing: 0.3rem;
        color: #fff;
        background: transparent;
        border: 2px solid rgba(255, 0, 255, 0.6);
        cursor: pointer;
        overflow: hidden;
        transition: all 0.3s ease;
        font-family: "Courier New", monospace;
        box-shadow:
          0 0 30px rgba(255, 0, 255, 0.3),
          inset 0 0 30px rgba(255, 0, 255, 0.1);
      }

      .home-wrapper .enter-btn:hover {
        border-color: rgba(0, 255, 255, 0.8);
        box-shadow:
          0 0 50px rgba(0, 255, 255, 0.6),
          inset 0 0 30px rgba(0, 255, 255, 0.2);
        transform: scale(1.05);
      }

      .home-wrapper .btn-text {
        position: relative;
        z-index: 2;
        display: block;
      }

      .home-wrapper .btn-price {
        position: relative;
        z-index: 2;
        display: block;
        font-size: clamp(1.2rem, 3vw, 1.8rem);
        font-weight: 900;
        margin-top: 0.5rem;
        color: #00ffff;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
      }

      .home-wrapper .btn-glow {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 0, 255, 0.4),
          rgba(0, 255, 255, 0.4),
          transparent
        );
        transition: left 0.5s ease;
      }

      .enter-btn:hover .btn-glow {
        left: 100%;
      }

      /* Lifetime button variation */
      .home-wrapper .lifetime-btn {
        border-color: rgba(0, 255, 255, 0.6);
        box-shadow:
          0 0 30px rgba(0, 255, 255, 0.3),
          inset 0 0 30px rgba(0, 255, 255, 0.1);
      }

      .home-wrapper .lifetime-btn:hover {
        border-color: rgba(255, 0, 255, 0.8);
        box-shadow:
          0 0 50px rgba(255, 0, 255, 0.6),
          inset 0 0 30px rgba(255, 0, 255, 0.2);
      }

      .home-wrapper .lifetime-btn .btn-price {
        color: #ff00ff;
        text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
      }

      /* Login Link */
      .home-wrapper .login-link-container {
        margin-top: 1rem;
        text-align: center;
      }

      .home-wrapper .login-link {
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: clamp(0.85rem, 1.8vw, 1rem);
        letter-spacing: 0.1rem;
        transition: all 0.3s ease;
        border-bottom: 1px solid transparent;
        padding-bottom: 2px;
      }

      .home-wrapper .login-link:hover {
        color: rgba(0, 255, 255, 0.9);
        border-bottom-color: rgba(0, 255, 255, 0.5);
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      }

      /* Floating Orbs */
      .home-wrapper .orbs {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
      }

      .orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(40px);
        opacity: 0.3;
        animation: float 8s infinite ease-in-out;
      }

      .home-wrapper .orb-1 {
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, #ff00ff, transparent);
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }

      .home-wrapper .orb-2 {
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, #00ffff, transparent);
        top: 60%;
        right: 15%;
        animation-delay: 2s;
      }

      .orb-3 {
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, #ff00ff, transparent);
        bottom: 15%;
        left: 20%;
        animation-delay: 4s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        33% {
          transform: translate(30px, -30px) scale(1.1);
        }
        66% {
          transform: translate(-20px, 20px) scale(0.9);
        }
      }

      /* Scanlines Effect */
      .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.15),
          rgba(0, 0, 0, 0.15) 1px,
          transparent 1px,
          transparent 2px
        );
        pointer-events: none;
        z-index: 100;
        opacity: 0.3;
        animation: scanline-anim 8s linear infinite;
      }

      @keyframes scanline-anim {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(10px);
        }
      }

      /* Bottom Text */
      .bottom-text {
        position: absolute;
        bottom: 3rem;
        text-align: center;
        opacity: 0;
        animation: fade-in 2s ease-in-out 2.5s forwards;
      }

      .cryptic {
        font-size: clamp(0.9rem, 2vw, 1.2rem);
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 0.3rem;
        margin-bottom: 0.5rem;
        text-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
      }

      .cryptic-small {
        font-size: clamp(0.7rem, 1.5vw, 0.9rem);
        color: rgba(255, 255, 255, 0.5);
        letter-spacing: 0.2rem;
        font-style: italic;
      }

      /* Mobile Adjustments */
      @media (max-width: 768px) {
        .glitch {
          letter-spacing: 0.3rem;
        }

        .message {
          letter-spacing: 0.15rem;
        }

        .enter-btn {
          padding: 1rem 2rem;
          letter-spacing: 0.2rem;
        }

        .dual-buttons {
          gap: 1rem;
        }

        .btn-price {
          font-size: clamp(1rem, 4vw, 1.5rem);
        }

        .cryptic {
          letter-spacing: 0.15rem;
        }

        .orb {
          filter: blur(30px);
        }

        .home-wrapper .user-info-corner {
          top: 1rem;
          right: 1rem;
        }

        .home-wrapper .user-email-link {
          font-size: 0.75rem;
          padding: 0.5rem 0.8rem;
        }
      }
    </style>

    <!-- Pass price group data to client-side script -->
    <script define:vars={{ priceGroup: selectedPriceGroup }}>
      window.__homePriceGroup = priceGroup;
    </script>

    <script>
      // Import auth utilities
      import { getAccessToken, storeAuth } from "@/lib/auth";

      // Type declarations
      declare global {
        interface Window {
          __homePriceGroup: {
            id: string;
            membership: { monthly: number; currency: string };
            lifetime: { price: number; currency: string };
          };
        }
      }

      // Get price group from page
      const priceGroup = window.__homePriceGroup;

      // Button click effect
      function handleButtonClick(btn: HTMLElement) {
        btn.style.transform = "scale(0.95)";
        setTimeout(() => {
          btn.style.transform = "scale(1.05)";
        }, 100);
      }

      // Check if user is authenticated
      function isAuthenticated() {
        return getAccessToken() !== null;
      }

      // Create checkout session for membership
      async function createMembershipCheckout() {
        const membershipBtn = document.querySelector(".membership-btn");
        const btnText = membershipBtn?.querySelector(".btn-text");
        const originalText = btnText?.textContent;

        try {
          if (btnText) btnText.textContent = "Loading...";

          // Open new tab immediately to avoid popup blockers
          const stripeWindow = window.open("about:blank", "_blank");

          // Show loading message in the new tab
          if (stripeWindow) {
            stripeWindow.document.write(`
              <html>
                <head>
                  <title>Loading...</title>
                  <style>
                    body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      height: 100vh;
                      margin: 0;
                      background: #f9fafb;
                    }
                    .loader {
                      text-align: center;
                    }
                    .spinner {
                      border: 3px solid #e5e7eb;
                      border-top: 3px solid #3b82f6;
                      border-radius: 50%;
                      width: 40px;
                      height: 40px;
                      animation: spin 1s linear infinite;
                      margin: 0 auto 16px;
                    }
                    @keyframes spin {
                      0% { transform: rotate(0deg); }
                      100% { transform: rotate(360deg); }
                    }
                  </style>
                </head>
                <body>
                  <div class="loader">
                    <div class="spinner"></div>
                    <p>Redirecting to Stripe...</p>
                  </div>
                </body>
              </html>
            `);
          }

          // Extract user email from token
          let customerEmail = null;
          const token = getAccessToken();
          if (token) {
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              customerEmail = payload.email;
            } catch (e) {
              console.error("Error decoding token:", e);
            }
          }

          // Call API to create membership checkout session
          const response = await fetch("/api/stripe/create-membership-session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              profileId: null, // null for app memberships
              membershipPrice: priceGroup.membership.monthly * 100, // Convert to cents
              priceId: priceGroup.id, // Pass price group ID for A/B testing tracking
              // Don't pass successUrl/cancelUrl - let backend use defaults with redirect tokens
              // Will redirect to home page (/) with membership=success/canceled params
              customerEmail,
              language: "en", // TODO: Get from page language
              displayName: "Premium Access",
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to create checkout session"
            );
          }

          const data = await response.json();

          // Redirect the opened tab to Stripe checkout
          if (data.url && stripeWindow) {
            stripeWindow.location.href = data.url;
          } else if (!stripeWindow) {
            // Fallback if popup was blocked
            window.location.href = data.url;
          } else {
            throw new Error("No checkout URL received");
          }

          // Restore button text
          if (btnText && originalText) btnText.textContent = originalText;
        } catch (error) {
          console.error("Error creating membership checkout:", error);
          alert("Failed to start checkout. Please try again.");

          // Restore button text
          if (btnText && originalText) btnText.textContent = originalText;
        }
      }

      // Create checkout session for lifetime
      async function createLifetimeCheckout() {
        const lifetimeBtn = document.querySelector(".lifetime-btn");
        const btnText = lifetimeBtn?.querySelector(".btn-text");
        const originalText = btnText?.textContent;

        try {
          if (btnText) btnText.textContent = "Loading...";

          // Open new tab immediately to avoid popup blockers
          const stripeWindow = window.open("about:blank", "_blank");

          // Show loading message in the new tab
          if (stripeWindow) {
            stripeWindow.document.write(`
              <html>
                <head>
                  <title>Loading...</title>
                  <style>
                    body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      height: 100vh;
                      margin: 0;
                      background: #f9fafb;
                    }
                    .loader {
                      text-align: center;
                    }
                    .spinner {
                      border: 3px solid #e5e7eb;
                      border-top: 3px solid #3b82f6;
                      border-radius: 50%;
                      width: 40px;
                      height: 40px;
                      animation: spin 1s linear infinite;
                      margin: 0 auto 16px;
                    }
                    @keyframes spin {
                      0% { transform: rotate(0deg); }
                      100% { transform: rotate(360deg); }
                    }
                  </style>
                </head>
                <body>
                  <div class="loader">
                    <div class="spinner"></div>
                    <p>Redirecting to Stripe...</p>
                  </div>
                </body>
              </html>
            `);
          }

          // Extract user email from token
          let customerEmail = null;
          const token = getAccessToken();
          if (token) {
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              customerEmail = payload.email;
            } catch (e) {
              console.error("Error decoding token:", e);
            }
          }

          // Call API to create lifetime checkout session
          const response = await fetch(
            "/api/stripe/create-content-checkout-session",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                profileId: null, // null for app lifetime access
                videoId: null, // null for app lifetime access
                contentPrice: priceGroup.lifetime.price * 100, // Convert to cents
                priceId: priceGroup.id, // Pass price group ID for A/B testing tracking
                // Don't pass successUrl/cancelUrl - let backend use defaults with redirect tokens
                // Will redirect to home page (/) with purchase=success/canceled params
                customerEmail,
                language: "en", // TODO: Get from page language
                videoTitle: "Lifetime Access",
                creatorDisplayName: "Premium Access",
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Failed to create checkout session"
            );
          }

          const data = await response.json();

          // Redirect the opened tab to Stripe checkout
          if (data.url && stripeWindow) {
            stripeWindow.location.href = data.url;
          } else if (!stripeWindow) {
            // Fallback if popup was blocked
            window.location.href = data.url;
          } else {
            throw new Error("No checkout URL received");
          }

          // Restore button text
          if (btnText && originalText) btnText.textContent = originalText;
        } catch (error) {
          console.error("Error creating lifetime checkout:", error);
          alert("Failed to start checkout. Please try again.");

          // Restore button text
          if (btnText && originalText) btnText.textContent = originalText;
        }
      }

      // Handle membership button click
      const membershipBtn = document.querySelector(
        ".membership-btn"
      ) as HTMLElement | null;
      membershipBtn?.addEventListener("click", async () => {
        if (membershipBtn) handleButtonClick(membershipBtn);

        // Check if user is logged in
        if (!isAuthenticated()) {
          // Store purchase type in sessionStorage for after login
          sessionStorage.setItem("qwb_purchase_type", "membership");

          // User not logged in - redirect to login with return URL
          const currentUrl = window.location.pathname;
          window.location.href = `/login?redirect=${encodeURIComponent(currentUrl)}`;
          return;
        }

        // User is logged in - create checkout session
        await createMembershipCheckout();
      });

      // Handle lifetime button click
      const lifetimeBtn = document.querySelector(
        ".lifetime-btn"
      ) as HTMLElement | null;
      lifetimeBtn?.addEventListener("click", async () => {
        if (lifetimeBtn) handleButtonClick(lifetimeBtn);

        // Check if user is logged in
        if (!isAuthenticated()) {
          // Store purchase type in sessionStorage for after login
          sessionStorage.setItem("qwb_purchase_type", "lifetime");

          // User not logged in - redirect to login with return URL
          const currentUrl = window.location.pathname;
          window.location.href = `/login?redirect=${encodeURIComponent(currentUrl)}`;
          return;
        }

        // User is logged in - create checkout session
        await createLifetimeCheckout();
      });

      // Check if we should open checkout after login
      const purchaseType = sessionStorage.getItem("qwb_purchase_type");
      if (purchaseType && isAuthenticated()) {
        sessionStorage.removeItem("qwb_purchase_type");

        // Wait a bit for the page to load, then trigger checkout
        setTimeout(() => {
          if (purchaseType === "membership") {
            createMembershipCheckout();
          } else if (purchaseType === "lifetime") {
            createLifetimeCheckout();
          }
        }, 500);
      }

      // Handle successful Stripe checkout (membership)
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session_id");
      const membershipStatus = urlParams.get("membership");
      const purchaseStatus = urlParams.get("purchase");

      if (sessionId && membershipStatus === "success") {
        (async () => {
          try {
            console.log("Processing membership checkout success...");
            
            // Call backend to verify session and get access token
            const response = await fetch("/api/auth/verify-session", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                sessionId,
                profileId: null, // null for app memberships
              }),
            });

            if (!response.ok) {
              const errorData = await response
                .json()
                .catch(() => ({ error: "Unknown error" }));
              const errorMessage =
                errorData.error || errorData.message || "Failed to verify session";
              console.error("Backend error:", errorData);
              throw new Error(errorMessage);
            }

            const data = await response.json();

            // Store auth data in cookies
            storeAuth({
              accessToken: data.data.accessToken,
              refreshToken: data.data.refreshToken,
              user: data.data.user,
            });

            console.log("✅ Membership saved to database!");

            // Remove query params from URL
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );

            // Reload the page to show "YEAAA ! I HAVE ACCESS" message
            console.log("Reloading page to show access granted...");
            window.location.reload();
          } catch (error) {
            console.error("Error verifying session:", error);

            // Remove query params even on error to prevent repeated alerts
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );

            // Show detailed error message
            const errorMessage =
              error instanceof Error ? error.message : "Unknown error";
            alert(
              `Payment successful, but failed to activate membership.\n\nError: ${errorMessage}\n\nPlease contact support with session ID: ${sessionId}`
            );
          }
        })();
      } else if (membershipStatus === "canceled") {
        console.log("Membership checkout was canceled");
        // Clean up URL params
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // Handle successful content purchase (lifetime)
      if (purchaseStatus === "success") {
        (async () => {
          try {
            console.log("Processing lifetime purchase success...");

            // Refresh token to get updated purchased content list
            const token = getAccessToken();
            if (token) {
              const response = await fetch("/api/auth/verify-token", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ token }),
              });

              if (response.ok) {
                const data = await response.json();
                console.log("✅ Purchase verified in database!");

                // Remove query params from URL
                window.history.replaceState(
                  {},
                  document.title,
                  window.location.pathname
                );

                // Reload to show access granted
                console.log("Reloading page to show access granted...");
                window.location.reload();
              }
            }
          } catch (error) {
            console.error("Error processing purchase:", error);

            // Remove query params even on error
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );
          }
        })();
      } else if (purchaseStatus === "canceled") {
        console.log("Purchase checkout was canceled");
        // Clean up URL params
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // Add random glitch intervals
      setInterval(() => {
        if (Math.random() > 0.95) {
          document.body.style.filter = "hue-rotate(180deg)";
          setTimeout(() => {
            document.body.style.filter = "none";
          }, 50);
        }
      }, 2000);

      // Mouse move parallax effect
      document.addEventListener("mousemove", (e) => {
        const orbs = document.querySelectorAll(".orb");
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;

        orbs.forEach((orb, index) => {
          const speed = (index + 1) * 20;
          (orb as HTMLElement).style.transform =
            `translate(${x * speed}px, ${y * speed}px)`;
        });
      });
    </script>
  </div>

  <style>
    .home-wrapper {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: "Courier New", monospace;
      background: #000;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
    }
  </style>
</LayoutApp>
